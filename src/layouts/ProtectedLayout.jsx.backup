import { useState } from "react";
import {
  AppBar,
  Box,
  Toolbar,
  IconButton,
  Typography,
  Avatar,
  Container,
  Tabs,
  Tab,
  useMediaQuery,
  useTheme,
  Drawer,
  List,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Divider,
  Stack,
} from "@mui/material";
import MenuIcon from "@mui/icons-material/Menu";
import CloseIcon from "@mui/icons-material/Close";
import { User } from "lucide-react";

function ProtectedLayout({
  user,
  organizationName,
  organizationSlug,
  activeView,
  onNavigate,
  navItems = [],
  children,
}) {
  const [mobileOpen, setMobileOpen] = useState(false);
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));
  const isVerySmallScreen = useMediaQuery("(max-width: 400px)");
  const isDesktop = useMediaQuery(theme.breakpoints.up("lg"));

  const handleNavigate = (key) => {
    if (onNavigate) {
      onNavigate(key);
    }
    setMobileOpen(false);
  };

  const handleDrawerToggle = () => {
    setMobileOpen(!mobileOpen);
  };

  const drawer = (
    <Box sx={{ width: { xs: "85vw", sm: 280 }, maxWidth: 320, display: "flex", flexDirection: "column", height: "100%" }}>
      <Box sx={{ p: { xs: 1.5, sm: 2 }, display: "flex", justifyContent: "flex-end", alignItems: "center" }}>
        <IconButton onClick={handleDrawerToggle} size="small">
          <CloseIcon />
        </IconButton>
      </Box>
      <Divider />
      <Box sx={{ px: { xs: 1.5, sm: 2 }, py: { xs: 2, sm: 3 } }}>
        <Stack spacing={1} alignItems="center" sx={{ mb: { xs: 2, sm: 3 } }}>
          <Avatar
            sx={{ width: { xs: 56, sm: 64 }, height: { xs: 56, sm: 64 } }}
            src={user?.avatar_url || user?.avatarUrl || undefined}
          >
            <User size={isVerySmallScreen ? 20 : 24} />
          </Avatar>
          <Typography variant="subtitle1" fontWeight={600} sx={{ fontSize: { xs: "0.9375rem", sm: "1rem" } }}>
            {user?.en_name || user?.name || "User"}
          </Typography>
          <Typography variant="caption" color="text.secondary" sx={{ fontSize: { xs: "0.7rem", sm: "0.75rem" } }}>
            {organizationName || organizationSlug || "Organisation"}
          </Typography>
        </Stack>
        <List sx={{ py: 0 }}>
          {navItems.map((item) => {
            const Icon = item.icon;
            const selected = item.key === activeView;
            return (
              <ListItemButton
                key={item.key}
                selected={selected}
                onClick={() => handleNavigate(item.key)}
                sx={{ borderRadius: 2, mb: 0.5, py: { xs: 1, sm: 1.25 } }}
              >
                <ListItemIcon sx={{ minWidth: { xs: 36, sm: 40 } }}>
                  <Icon size={isVerySmallScreen ? 18 : 20} />
                </ListItemIcon>
                <ListItemText 
                  primary={item.label} 
                  primaryTypographyProps={{ 
                    fontSize: { xs: "0.875rem", sm: "0.9375rem" } 
                  }} 
                />
              </ListItemButton>
            );
          })}
        </List>
      </Box>
      <Box sx={{ p: { xs: 1.5, sm: 2 }, mt: "auto" }}>
        <Typography variant="caption" color="text.secondary" align="center" display="block" sx={{ fontSize: { xs: "0.65rem", sm: "0.75rem" } }}>
          © 2025 Inside Advisory
        </Typography>
      </Box>
    </Box>
  );

  return (
    <Box sx={{ display: "flex", flexDirection: "column", minHeight: "100vh" }}>
      <style>
        {`
          * {
            scrollbar-width: none;
            -ms-overflow-style: none;
          }
          *::-webkit-scrollbar {
            display: none;
          }
        `}
      </style>
      <AppBar
        position="sticky"
        elevation={0}
        sx={{
          backgroundColor: "background.paper",
          borderBottom: 1,
          borderColor: "divider",
          color: "text.primary",
        }}
      >
        <Container maxWidth={false} sx={{ px: { xs: 0.75, sm: 1, md: 1.5 } }}>
          <Toolbar 
            disableGutters 
            sx={{ 
              minHeight: { xs: 44, sm: 46, md: 48 }, 
              py: 0, 
              justifyContent: "space-between", 
              alignItems: "center",
              gap: { xs: 0.5, sm: 1, md: 1.5 },
            }}
          >
            {isMobile && (
              <IconButton
                size="small"
                edge="start"
                onClick={handleDrawerToggle}
                sx={{ 
                  p: { xs: 0.5, sm: 0.75 },
                  minWidth: { xs: 36, sm: 40 },
                }}
              >
                <MenuIcon fontSize={isVerySmallScreen ? "small" : "medium"} />
              </IconButton>
            )}

            {!isMobile && (
              <Box sx={{ flex: 1, display: "flex", alignItems: "center", minWidth: 0, mr: { md: 1.5, lg: 2 } }}>
                <Tabs
                  value={activeView}
                  onChange={(e, newValue) => handleNavigate(newValue)}
                  sx={{ 
                    height: { md: 48, lg: 48 },
                    minWidth: 0,
                    width: "100%",
                    "& .MuiTabs-scrollButtons": {
                      width: { md: 24, lg: 28 },
                    },
                    "& .MuiTabs-indicator": {
                      display: "none",
                    },
                    "& .MuiTabs-flexContainer": {
                      gap: 0,
                    },
                  }}
                  variant={isDesktop ? "standard" : "scrollable"}
                  scrollButtons={isDesktop ? false : "auto"}
                >
                  {navItems.map((item) => {
                    const isSelected = item.key === activeView;
                    return (
                      <Tab
                        key={item.key}
                        label={item.label}
                        value={item.key}
                        sx={{ 
                          minHeight: { md: 48, lg: 48 },
                          minWidth: 0,
                          flex: isDesktop ? 1 : "none",
                          px: { md: 1, lg: 1.5 },
                          textTransform: "none", 
                          fontSize: { md: "0.75rem", lg: "0.8125rem" },
                          fontWeight: isSelected ? 600 : 500,
                          color: isSelected ? "primary.main" : "text.secondary",
                          borderBottom: isSelected ? "2px solid" : "2px solid transparent",
                          borderBottomColor: isSelected ? "primary.main" : "transparent",
                          borderRadius: 0,
                          "&:hover": {
                            color: "primary.main",
                            backgroundColor: "transparent",
                          },
                          "&.Mui-selected": {
                            color: "primary.main",
                            borderLeft: "none",
                            borderRight: "none",
                            borderTop: "none",
                          },
                        }}
                      />
                    );
                  })}
                </Tabs>
              </Box>
            )}

            <Box sx={{ display: "flex", alignItems: "center", flexShrink: 0, ml: "auto" }}>
              <Box
                sx={{
                  display: "flex",
                  alignItems: "center",
                  gap: { xs: 0, sm: 0.5, md: 0.75, lg: 1 },
                  px: { xs: 0.25, sm: 0.5, md: 0.75, lg: 1 },
                  py: { xs: 0.25, sm: 0.25, md: 0.5 },
                }}
              >
                <Avatar
                  alt={user?.en_name || user?.name}
                  src={user?.avatar_url || user?.avatarUrl || undefined}
                  sx={{ 
                    width: { 
                      xs: isVerySmallScreen ? 28 : 30, 
                      sm: 32, 
                      md: 28, 
                      lg: 32 
                    }, 
                    height: { 
                      xs: isVerySmallScreen ? 28 : 30, 
                      sm: 32, 
                      md: 28, 
                      lg: 32 
                    }, 
                    flexShrink: 0,
                  }}
                >
                  <User size={isVerySmallScreen ? 14 : 16} />
                </Avatar>
                <Stack 
                  spacing={0} 
                  alignItems="flex-start" 
                  sx={{ 
                    display: { 
                      xs: "none", 
                      sm: isVerySmallScreen ? "none" : "flex",
                      md: "flex",
                      lg: "flex" 
                    },
                    minWidth: 0,
                    maxWidth: { sm: 120, md: 150, lg: 180 },
                    flexShrink: 0,
                  }}
                >
                  <Typography 
                    variant="body2" 
                    fontWeight={600} 
                    noWrap 
                    sx={{ 
                      fontSize: { sm: "0.7rem", md: "0.75rem", lg: "0.8125rem" },
                      lineHeight: 1.2,
                      overflow: "hidden",
                      textOverflow: "ellipsis",
                      width: "100%",
                    }}
                  >
                    {user?.en_name || user?.name || "User"}
                  </Typography>
                  <Typography 
                    variant="caption" 
                    color="text.secondary" 
                    noWrap 
                    sx={{ 
                      fontSize: { sm: "0.6rem", md: "0.625rem", lg: "0.6875rem" },
                      lineHeight: 1,
                      overflow: "hidden",
                      textOverflow: "ellipsis",
                      width: "100%",
                      display: { sm: "none", md: "block", lg: "block" },
                    }}
                  >
                    {organizationName || organizationSlug || "Organisation"}
                  </Typography>
                </Stack>
              </Box>
            </Box>
          </Toolbar>
        </Container>
      </AppBar>

      <Drawer
        variant="temporary"
        open={mobileOpen}
        onClose={handleDrawerToggle}
        ModalProps={{ keepMounted: true }}
        sx={{
          display: { xs: "block", md: "none" },
          "& .MuiDrawer-paper": { 
            boxSizing: "border-box", 
            width: { xs: "85vw", sm: 280 },
            maxWidth: 320,
          },
        }}
      >
        {drawer}
      </Drawer>

      <Box
        component="main"
        sx={{
          flexGrow: 1,
          backgroundColor: "background.default",
          minHeight: { xs: "calc(100vh - 44px)", sm: "calc(100vh - 46px)", md: "calc(100vh - 48px)" },
        }}
      >
        <Container
          maxWidth={false}
          disableGutters={activeView === 'strategic_map'}
          sx={{
            px: activeView === 'strategic_map' ? 0 : { xs: 2, sm: 3, md: 4 },
            py: activeView === 'strategic_map' ? 0 : { xs: 2.5, md: 3.5 },
          }}
        >
          {children}
        </Container>
      </Box>

      <Box
        component="footer"
        sx={{
          py: 2,
          px: 2,
          mt: "auto",
          backgroundColor: "background.paper",
          borderTop: 1,
          borderColor: "divider",
        }}
      >
        <Container maxWidth={false}>
          <Typography variant="caption" color="text.secondary" align="center" display="block">
            © 2025 Inside Advisory. All rights reserved.
          </Typography>
        </Container>
      </Box>
    </Box>
  );
}

export default ProtectedLayout;
