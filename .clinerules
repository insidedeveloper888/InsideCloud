# .clinerules - Project Context for Claude Code

## Project Identity
Multi-tenant SaaS ERP system for Malaysian SMEs, integrated with Lark (Feishu) platform.
Supports 6 core business modules with data-driven automation and reporting.

## Tech Stack
- **Frontend**: React 18 + Tailwind CSS 3.4 + shadcn/ui
- **Backend**: Koa 2 (dev on port 8989) + Vercel Serverless (prod)
- **Database**: Supabase (PostgreSQL + Realtime)
- **Authentication**: Lark OAuth 2.0 + JSAPI
- **Deployment**: Vercel (production) + localhost (development)

## Architecture Principles (NEVER VIOLATE)

### 1. Multi-Tenant Isolation
- ALL database tables MUST have `organization_id` or `tenant_id` field
- ALL queries MUST filter by organization/tenant
- Organization context stored in localStorage: `organization_slug`
- Backend validates organization exists before processing requests

### 2. Module Independence with Event System
- 6 modules: Strategic Map, Contact Management, Sales Management, Inventory, Integrations, Document Parser
- Modules communicate via event system (NOT direct calls)
- Each module has dedicated controller, API handlers, and frontend tool directory

### 3. Dual Deployment Architecture
**CRITICAL**: When adding new API endpoints, implement in BOTH places:

**Development (Koa - server/server.js):**
```javascript
// STEP 1: Always add OPTIONS handler for CORS preflight
router.options('/api/new-endpoint', async (ctx) => {
  serverUtil.configAccessControl(ctx);
  ctx.status = 200;
});

// STEP 2: Add actual route
router.get('/api/new-endpoint', async (ctx) => {
  serverUtil.configAccessControl(ctx);
  const param = ctx.query.param;
  // ... implementation
  ctx.body = { code: 0, data: result };
});
```

**Production (Vercel - api/[...path].js + handler):**
```javascript
// Create handler: server/api_handlers/new_endpoint.js
module.exports = async function handler(req, res) {
  if (handleCors(req, res)) return;
  const param = req.query.param;
  // ... same implementation logic
  res.status(200).json({ code: 0, data: result });
};

// Register in api/[...path].js
const routes = { '/api/new-endpoint': newEndpoint };
```

### 4. React Router + Product Access Control
When adding new product route:
1. Add route to `src/App.js`: `<Route path="/new_product" element={<Home />} />`
2. Add to access control in `src/pages/home/index.js`:
   ```javascript
   if (!isAdmin && activeView !== 'dashboard' &&
       activeView !== 'new_product') {
     setActiveView('dashboard');
   }
   ```

## UI Component Guidelines

### MANDATORY: Use Shared Components
Before creating ANY new UI component, check `src/components/ui/` for existing components:

| Component | File | Status | Use For |
|-----------|------|--------|---------|
| Button | `button.jsx` | ‚úÖ Ready | All buttons |
| Card | `card.jsx` | ‚úÖ Ready | Content containers |
| Tabs | `tabs.jsx` | ‚úÖ Ready | Tab navigation |
| Avatar | `avatar.jsx` | ‚úÖ Ready | User avatars |
| MemberSelect | `member-select.jsx` | ‚úÖ Ready | Team member dropdowns |
| Pagination | `pagination.jsx` | ‚úÖ Ready | List pagination |
| ConfirmDialog | `confirm-dialog.jsx` | ‚úÖ Ready | Delete/dangerous action confirmations |

### MANDATORY: Use Design Tokens
Import from `src/lib/design-tokens.js` for consistent styling:
- `buttonStyles` - All button variants
- `badgeStyles` - Status badges
- `colors` - Color palette
- `radius` - Border radius
- `typography` - Text styles

### Creating New Components
1. First check if similar component exists in `src/components/ui/`
2. If creating new, place in `src/components/ui/` (NOT in tool-specific folders)
3. Use design tokens, not hardcoded Tailwind classes
4. Add to `src/components/ui/index.js` exports
5. Document in `docs/design-system/README.md`

### DO NOT:
- ‚ùå Create duplicate components in tool folders
- ‚ùå Use different button styles across tools
- ‚ùå Hardcode colors (use design tokens)
- ‚ùå Create tool-specific Modal/Dialog/Select components

### DO:
- ‚úÖ Import from `@/components/ui/` or `src/components/ui/`
- ‚úÖ Extend shared components with props if needed
- ‚úÖ Follow existing patterns in inventory-management (best reference)

## 6 Core Modules (See /docs/agents/ for details)

### 1. Strategic Map (ÊàòÁï•Âú∞Âõæ)
- **Purpose**: 5-year planning with goal cascading (yearly ‚Üí monthly ‚Üí weekly ‚Üí daily)
- **Status**: ‚úÖ Production Ready (v2.2.0)
- **Files**: `src/tools/strategic-map/`, `server/strategic_map_controller.js`
- **Database**: Cascade triggers auto-create monthly/weekly/daily goals
- **Features**: Supabase Realtime collaboration, optimistic updates

### 2. Contact Management (ÂêçÂçïÁÆ°ÁêÜ)
- **Purpose**: CRM for customers, suppliers, COI, internal contacts
- **Status**: ‚úÖ Production Ready (v1.0.0)
- **Files**: `src/tools/contact-management/`, `server/contact_management_controller.js`
- **Features**: Configurable rating (3-10 stars), pipeline stages, traffic channels, tags

### 3. Sales Management (ÈîÄÂîÆÁÆ°ÁêÜ)
- **Purpose**: Document workflow (Quotation ‚Üí Sales Order ‚Üí Delivery Order ‚Üí Invoice)
- **Status**: ‚úÖ Production Ready (v1.0.0)
- **Files**: `src/tools/sales-management/`, `server/*_controller.js` (quotation, sales_order, delivery_order, invoice, template, pdf_generator)
- **Features**: Visual PDF template builder, auto-fill conversion, payment tracking

### 4. Inventory Management (‰ªìÂ∫ìÁÆ°ÁêÜ)
- **Purpose**: Multi-location stock tracking, purchase orders, suppliers
- **Status**: ‚úÖ Production Ready (v1.0.0)
- **Files**: `src/tools/inventory/`, `server/inventory_controller.js`
- **Features**: Stock movements (IN/OUT), low stock alerts, batch recording

### 5. Integrations (ÈõÜÊàê)
- **Purpose**: Third-party software connections (accounting, social platforms)
- **Status**: üöß In Development (Backend Only)
- **Files**: `server/integrations_controller.js`
- **Note**: Frontend `src/tools/integrations/` not yet created
- **Features**: OAuth flows, data sync, webhook handlers

### 6. Document Parser (ÊñáÊ°£Ëß£ÊûêÂô®)
- **Purpose**: Parse accounting software exports (SQL Accounting, Autocount)
- **Status**: ‚úÖ Production Ready (v1.0.0)
- **Files**: `src/tools/document-parser/`
- **Features**: Pure frontend, no backend/database, Excel/CSV support

## Critical File Locations

### Backend
- **Main Server**: `server/server.js` (Koa routes for dev)
- **Vercel Router**: `api/[...path].js` (unified router for prod)
- **API Handlers**: `server/api_handlers/` (one file per endpoint)
- **Controllers**: `server/*_controller.js` (business logic)
- **Database Client**: `server/supabase_client.js`
- **Organization Helper**: `server/organization_helper.js` (multi-tenant utilities)

### Frontend
- **Entry Point**: `src/pages/home/index.js` (dashboard + product routing)
- **Tools Directory**: `src/tools/` (one folder per product)
- **Shared Components**: `src/components/ui/` (shadcn/ui), `src/components/layout/`
- **Organization Context**: `src/contexts/OrganizationContext.jsx`
- **Authentication**: `src/utils/auth_access_util.js`

### Configuration
- **CLAUDE.md**: Comprehensive project documentation (READ THIS FIRST)
- **ARCHITECTURE.md**: Architecture decisions, UI/UX standards
- **package.json**: Scripts for dev/build/deploy

### Database
- **Migrations**: `docs/migrations/` (SQL schema changes)
- **Schemas**: `docs/sql-scripts/` (complete table definitions per module)

## Common Mistakes to Avoid

### ‚ùå Mistake 1: Forgetting CORS Preflight Handler
**Symptom**: CORS error in browser, "No 'Access-Control-Allow-Origin' header"
**Fix**: Always add OPTIONS handler before GET/POST/etc

### ‚ùå Mistake 2: Adding Route but Forgetting Access Control
**Symptom**: URL changes, then immediately redirects to dashboard
**Fix**: Update both `App.js` routes and `Home` component access control

### ‚ùå Mistake 3: Direct Module-to-Module Calls
**Symptom**: Tight coupling, difficult to refactor
**Fix**: Use event system (eventBus.emit/on)

### ‚ùå Mistake 4: Missing Tenant Filter in Queries
**Symptom**: Users see data from other organizations
**Fix**: ALWAYS filter by `organization_id` or `tenant_id`

### ‚ùå Mistake 5: Using localStorage for Critical State
**Symptom**: Data lost on logout, not synced across devices
**Fix**: Store in Supabase, use localStorage only for UX preferences

## Development Workflow

### Starting Development Server
```bash
# ALWAYS use this command to avoid port conflicts
pkill -f "server/server.js"; pkill -f "react-scripts"; npm run start
```

### Adding New Product/Module
1. Create tool directory: `src/tools/new-module/`
2. Create controller: `server/new_module_controller.js`
3. Create API handlers: `server/api_handlers/new_module.js`
4. Add routes to `server/server.js` (Koa)
5. Add handler to `api/[...path].js` (Vercel)
6. Add route to `src/App.js`
7. Add access control to `src/pages/home/index.js`
8. Create agent file: `/docs/agents/new-module-agent.md`

### Debugging Checklist
1. **CORS errors**: Check OPTIONS handler exists
2. **Tenant data leakage**: Verify organization_id filter in all queries
3. **API not found in dev**: Check Koa route in `server/server.js`
4. **API not found in prod**: Check handler registered in `api/[...path].js`
5. **Navigation not working**: Check both App.js route and Home access control

## Database Patterns

### Multi-Tenant Table Structure
```sql
CREATE TABLE example_table (
  id UUID PRIMARY KEY,
  organization_id UUID NOT NULL REFERENCES organizations(id),
  -- other fields
  CONSTRAINT unique_per_org UNIQUE (organization_id, unique_field)
);
```

### Row-Level Security (RLS)
```sql
CREATE POLICY tenant_isolation ON example_table
  FOR ALL USING (
    organization_id = current_setting('app.current_organization_id')::UUID
  );
```

## MCP Servers Required

### 1. Supabase MCP
**Purpose**: Direct database schema access
**Installation**: See claude_desktop_config.json
**Benefit**: Claude Code can query table structures without asking you

### 2. Filesystem MCP
**Purpose**: Project structure navigation
**Installation**: Pre-configured
**Benefit**: Claude Code can explore directories without explicit file paths

## Quick Reference

- **API Base URL (Dev)**: `http://localhost:8989/api/*`
- **API Base URL (Prod)**: `https://your-domain.vercel.app/api/*`
- **Frontend Dev Server**: `http://localhost:3000`
- **Lark OAuth Redirect**: Same as frontend URL
- **Session Cookie Name**: `lk_token`
- **Organization Slug Key**: `organization_slug` (localStorage)

## When Claude Code "Forgets"

If Claude Code seems to forget project context:
1. Explicitly say: "Read .clinerules first"
2. Reference specific agent: "Act as Sales Management Agent (see /docs/agents/sales-agent.md)"
3. Check context window: If conversation too long, start new session and re-read .clinerules

## Documentation Priority

1. **CLAUDE.md** - Read this for operational commands and workflows
2. **ARCHITECTURE.md** - Read this for design decisions and standards
3. **/docs/agents/** - Read relevant agent file for module-specific work
4. **/docs/[module]/*** - Read for detailed implementation guides

---

Last Updated: 2025-11-26
Project Version: Strategic Map v2.2.0, Sales v1.0.0, Contact v1.0.0, Inventory v1.0.0