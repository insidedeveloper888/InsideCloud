# .clinerules - Core Principles (Foundation Layer)

> **READ THIS FIRST** before any coding task. For detailed patterns, see `/docs/patterns/`.

---

## ğŸ¯ Project Identity

Multi-tenant SaaS ERP for Malaysian SMEs on Lark platform.
**6 Core Modules**: Strategic Map, Contact Mgmt, Sales Mgmt, Inventory, Integrations, Document Parser.

**Tech Stack**: React 18 + Tailwind CSS + shadcn/ui | Koa 2 (dev) + Vercel (prod) | Supabase (PostgreSQL)

---

## ğŸš« NEVER VIOLATE (Critical Rules)

### 1. Multi-Tenant Isolation âš ï¸ DATA SECURITY
```
âŒ VIOLATION = Data leak between organizations
```

**MUST DO:**
- ALL tables: Include `organization_id` or `tenant_id` field
- ALL queries: Filter by `organization_id` (no exceptions)
- Backend: Validate organization exists before any operation

**Pattern**: See `/docs/patterns/multi-tenant-queries.md`

---

### 2. Dual Deployment Architecture âš ï¸ DEV/PROD PARITY

**CRITICAL**: When adding API endpoint, implement in **BOTH** places:

| Environment | File | Pattern |
|-------------|------|---------|
| **Dev** | `server/server.js` | Koa router |
| **Prod** | `server/api_handlers/{name}.js` + `api/[...path].js` | Vercel handler |

**Common Mistake**: Implementing only in one place â†’ Works in dev, breaks in prod (or vice versa)

**Checklist**:
- [ ] Add OPTIONS handler for CORS preflight (both Koa + Vercel)
- [ ] Implement same business logic in both files
- [ ] Test in both `localhost:8989` and Vercel deployment

**Pattern**: See `/docs/patterns/api-design.md` for templates

---

### 3. Component Reuse First âš ï¸ NO DUPLICATION

**BEFORE creating ANY component**, check `src/components/ui/`:
- Button, Card, Tabs, Avatar, Pagination, ConfirmDialog, SearchableSelect, MemberSelect

**Rule**: If component exists, USE IT. Don't create duplicates in tool folders.

**Pattern**: See `/docs/design-system/component-library.md`

---

### 4. Router + Access Control Pattern âš ï¸ NAVIGATION

When adding new product/module route:

**2-Step Checklist**:
1. Add route: `src/App.js` â†’ `<Route path="/new_product" element={<Home />} />`
2. Add access control: `src/pages/home/index.js` â†’ Allow in `activeView` check

**Failure symptom**: URL changes but immediately redirects to dashboard

**Pattern**: See `/docs/patterns/routing.md`

---

## ğŸ”Œ MCP Integration (Model Context Protocol)

**Available MCP Servers** for enhanced capabilities:

### 1. Supabase MCP âœ…
```
Direct database schema access, query generation, migration helpers
```
**Use when**: Need to check table structure, generate complex queries, validate schema

### 2. Playwright MCP âœ…
```
Browser automation, E2E testing, UI verification
```
**Use when**: Testing workflows, validating UI interactions, debugging frontend

### 3. Filesystem MCP âœ…
```
Enhanced file navigation, bulk operations, project structure analysis
```
**Use when**: Finding files across large codebase, batch file operations

**Example Usage**:
```
"Use Supabase MCP to show me the schema for sales_orders table"
"Use Playwright MCP to test the contact form submission workflow"
"Use Filesystem MCP to find all components using Button"
```

---

## ğŸ“– Knowledge Base (Read as Needed)

| I want to... | Read this first |
|--------------|-----------------|
| Add new API endpoint | `/docs/patterns/api-design.md` |
| Add new module/product | `/docs/tasks/add-new-module.md` |
| Create database table | `/docs/patterns/database-schema.md` |
| Build UI component | `/docs/design-system/component-library.md` |
| Fix CORS error | `/docs/troubleshooting/cors-errors.md` |
| Fix data leak bug | `/docs/troubleshooting/multi-tenant-isolation.md` |
| Debug navigation | `/docs/troubleshooting/routing-issues.md` |
| Understand module X | `/docs/agents/{module}-agent.md` |

---

## ğŸ†˜ Quick Diagnostics

**Symptom â†’ Cause â†’ Fix**:
- `CORS error in browser` â†’ Missing OPTIONS handler â†’ Add `router.options()` in both Koa + Vercel
- `URL changes, then redirects` â†’ Missing access control â†’ Update `src/pages/home/index.js`
- `Users see other org's data` â†’ Missing tenant filter â†’ Add `.eq('organization_id', orgId)`
- `API 404 in dev` â†’ Route not in `server/server.js` â†’ Add Koa route
- `API 404 in prod` â†’ Route not registered â†’ Add to `api/[...path].js`

---

## ğŸ“š Documentation Hierarchy

```
Level 0: .clinerules (THIS FILE) â† Read first
  â†“
Level 1: /docs/patterns/ â† Implementation patterns (API, DB, UI)
  â†“
Level 2: /docs/agents/ â† Module-specific rules (sales-agent.md, etc.)
  â†“
Level 3: /docs/tasks/ â† Step-by-step guides (add-module.md, etc.)
  â†“
Level 4: CLAUDE.md, ARCHITECTURE.md â† Comprehensive reference
```

**When Claude Code "forgets"**: Start new session, say "Read .clinerules first"

---

Last Updated: 2025-11-28 | Version: 2.0 (Refactored for clarity)
