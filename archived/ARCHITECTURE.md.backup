# ARCHITECTURE.md
# InsideCloud - Multi-Tenant Lark Open Platform Integration Tool

**Version**: 2.0
**Last Updated**: 2025-11-14
**Maintained By**: Development Team + AI Agents (Claude Code)

---

## Table of Contents

1. [Project Overview](#project-overview)
2. [Architecture Decisions](#architecture-decisions)
3. [Component Standards](#component-standards)
4. [UI/UX Guidelines](#uiux-guidelines)
5. [Multi-Tenant Implementation](#multi-tenant-implementation)
6. [Lark Integration Patterns](#lark-integration-patterns)
7. [Development Workflow](#development-workflow)
8. [Change Log](#change-log)
9. [Onboarding Guide](#onboarding-guide)

---

## 1. Project Overview

### Purpose
InsideCloud is a multi-tenant SaaS platform that provides integrated tools for Lark (Feishu) workspace management, starting with strategic planning features and expanding to comprehensive workspace automation.

### Key Features
- **Multi-Tenant Architecture**: Each organization has isolated data and Lark credentials
- **Dual Authentication**: JSAPI (production) + OAuth (development)
- **Database-Driven Logic**: PostgreSQL triggers handle complex business rules
- **Hybrid Deployment**: Koa dev server + Vercel serverless production

### Technology Stack
```yaml
Frontend:
  - React 18.2.0
  - Tailwind CSS 3.4 (primary styling)
  - shadcn/ui (component library - planned)
  - Framer Motion (animations)
  - Lucide React (icons)
  - Material-UI 5 (legacy - being phased out)

Backend:
  - Node.js + Koa 2 (development)
  - Vercel Serverless Functions (production)
  - Supabase (PostgreSQL database)

External:
  - Lark Open Platform APIs
  - Lark H5 JS SDK
```

---

## 2. Architecture Decisions

### ADR-001: Tool-Based Project Structure
**Status**: Approved (2025-11-14)
**Context**: Need scalable organization for multiple Lark integration tools

**Decision**: Adopt `/src/tools/` folder structure where each tool is self-contained

**Rationale**:
- Current structure mixes components (`/components/StrategicMap/`) and pages (`/pages/strategic-map-v2/`)
- As we add more tools (Bitable sync, Calendar bridge, Task tracker), we need clear separation
- Tool-specific components should not pollute global `/components/` directory

**Structure**:
```
src/
â”œâ”€â”€ tools/                          # All Lark integration tools
â”‚   â”œâ”€â”€ strategic-map/             # Main strategic map tool
â”‚   â”‚   â”œâ”€â”€ index.jsx              # Main view
â”‚   â”‚   â”œâ”€â”€ components/            # Tool-specific components
â”‚   â”‚   â”œâ”€â”€ hooks/                 # Custom hooks
â”‚   â”‚   â””â”€â”€ utils/                 # Tool-specific utilities
â”‚   â”œâ”€â”€ bitable-sync/              # Future: Bitable integration tool
â”‚   â”œâ”€â”€ calendar-bridge/           # Future: Calendar integration
â”‚   â””â”€â”€ _template/                 # Template for new tools
â”œâ”€â”€ components/                     # Shared UI components only
â”‚   â”œâ”€â”€ ui/                        # shadcn/ui components
â”‚   â”œâ”€â”€ layout/                    # Layout components
â”‚   â””â”€â”€ organization/              # Organization-related components
â”œâ”€â”€ pages/                         # Top-level pages
â”‚   â”œâ”€â”€ home/                      # Dashboard
â”‚   â””â”€â”€ notfound/
â””â”€â”€ utils/                         # Global utilities
```

**Consequences**:
- âœ… Clear separation between tools
- âœ… Easy to add new tools
- âœ… Tool-specific components stay isolated
- âš ï¸ Requires strict component classification (shared vs tool-specific)

---

### ADR-002: Tailwind CSS + shadcn/ui over Material-UI
**Status**: Approved (2025-11-14)
**Context**: Material-UI creates bundle bloat, design inflexibility, and style conflicts with Lark integration

**Decision**: Migrate to Tailwind CSS with shadcn/ui component library

**Comparison**:
| Criteria | Material-UI 5 | Tailwind + shadcn/ui |
|----------|---------------|----------------------|
| **Bundle Size** | 300KB+ minified | 50-80KB (tree-shakable) |
| **Customization** | Theme override complexity | Direct utility control |
| **Modern Design** | Material Design (Google-centric) | Flexible, modern, professional |
| **Lark Integration** | Style conflicts | Neutral, adaptable |
| **Performance** | CSS-in-JS overhead | Static CSS generation |
| **Developer Experience** | Component props learning curve | Utility-first, copy-paste |

**shadcn/ui Benefits**:
- Not a dependency - copy-paste components you own
- Radix UI primitives - accessible, headless components
- Seamless Tailwind integration
- Multi-tenant friendly - easy theme customization per organization
- Professional & modern design out of the box

**Migration Strategy**:
1. **Phase 1**: Setup shadcn/ui infrastructure
2. **Phase 2**: Replace Material-UI in shared components (ProtectedLayout, OrganizationSelector)
3. **Phase 3**: Replace Material-UI in pages (home/index.js)
4. **Phase 4**: Remove Material-UI dependencies

**Consequences**:
- âœ… 70% smaller bundle size
- âœ… Better performance (no CSS-in-JS runtime)
- âœ… More design flexibility
- âœ… Copy-paste components = full control
- âš ï¸ Migration effort required (estimated 3-4 weeks)

---

### ADR-003: Database Triggers for Strategic Map Cascading
**Status**: Implemented (2024-12-20)
**Context**: Frontend cascade logic was error-prone, incomplete, and only worked for visible timeframes

**Decision**: Use PostgreSQL triggers to handle yearly â†’ monthly â†’ weekly â†’ daily cascading

**Problem Solved**:
- Auto-copy only worked for `focusYear` (current visible year)
- Didn't cascade to weekly/daily views
- Didn't work for other months (January â†’ last week/day)
- Manual copy logic in frontend was error-prone

**Implementation**:
- Database trigger fires on INSERT/UPDATE of strategic_map_items
- Automatically creates child items in next timeframe
- Tracks parent-child relationships via `parent_item_id`
- Ensures cascade happens regardless of which client makes the change

**Cascade Rules**:
| Source Timeframe | Target Timeframe | Target Date Logic |
|-----------------|------------------|-------------------|
| `yearly` (2024) | `monthly` | December 1, 2024 (`2024-12-01`) |
| `monthly` (Jan 2024) | `weekly` | Last week of January 2024 |
| `monthly` (Jan 2024) | `daily` | Last day of January 2024 (`2024-01-31`) |
| `weekly` (Week X) | `daily` | Last day of that week (Sunday) |

**Consequences**:
- âœ… Guaranteed consistency across all clients
- âœ… No race conditions
- âœ… Simplified frontend logic (silent refresh after save)
- âš ï¸ Database complexity increases
- âš ï¸ Harder to debug (requires SQL knowledge)

**Documentation**: See [docs/strategic-map/strategic-map-cascade-flow.md](docs/strategic-map/strategic-map-cascade-flow.md)

---

### ADR-004: Hybrid Deployment (Koa + Vercel)
**Status**: Active
**Context**: Need fast local development + scalable serverless production

**Decision**: Maintain identical logic in `server/server.js` (Koa) and `/api/*.js` (Vercel)

**Architecture**:
```
Development Mode:
  React Dev Server (port 3000)
    â†“ proxy /api/*
  Koa Server (port 8989)
    â†“
  Supabase + Lark APIs

Production Mode (Vercel):
  Static React Build
    â†“
  Vercel Serverless Functions (/api/)
    â†“
  Supabase + Lark APIs
```

**Code Sharing**:
- Shared utilities in `/lib/` (larkUserSync.js, etc.)
- API logic duplicated but uses same helpers
- `vercel.json` rewrites route requests to serverless functions

**Consequences**:
- âœ… Fast local development with hot reload
- âœ… Scalable production with serverless
- âœ… Same codebase for both environments
- âš ï¸ Code duplication (mitigated by shared `/lib` utilities)
- âš ï¸ Must update both Koa and Vercel handlers when adding new APIs

---

### ADR-005: Strategic Map v2 Pattern Over Component-Based
**Status**: Approved (2025-11-14)
**Context**: Two competing implementations exist:
- `src/components/StrategicMap/index.jsx` - 2,581 lines, Material-UI
- `src/pages/strategic-map-v2/index.jsx` - 187 lines, Tailwind/vanilla

**Decision**: Standardize on v2 pattern (page-based with inline components)

**Rationale**:
- **Code Clarity**: v2 is 13x more concise (187 vs 2,581 lines)
- **Modern Patterns**: Uses Tailwind utilities, avoiding CSS file sprawl
- **Scalability**: Easier to understand and maintain
- **Performance**: Lighter bundle, faster render

**Migration Plan**:
1. Move `src/pages/strategic-map-v2/` â†’ `src/tools/strategic-map/`
2. Archive `src/components/StrategicMap/` to `/archived/`
3. Extract reusable pieces from v1 as needed (into tool-specific components)
4. Remove old "æˆ˜ç•¥åœ°å›¾" card from dashboard (keep only v2)

**Consequences**:
- âœ… Single source of truth for strategic map
- âœ… Cleaner codebase
- âš ï¸ Must port missing features from v1 to v2 if needed

---

## 3. Component Standards

### Component Classification

**Shared Components** (`src/components/`):
- Used by multiple tools or pages
- Examples: Topbar, OrganizationSelector, ProtectedLayout
- Must not contain tool-specific logic
- Should be framework-agnostic (accept props, emit events)

**Tool Components** (`src/tools/{tool-name}/components/`):
- Specific to one tool
- Examples: StrategicTable, ChecklistItem (for strategic map)
- Can import shared components
- Can contain tool-specific business logic

**UI Primitives** (`src/components/ui/`):
- shadcn/ui components (Button, Card, Table, Tabs, Dialog, etc.)
- Must follow design system standards
- Accessible, headless, customizable
- Based on Radix UI primitives

### Component File Structure

```javascript
// src/tools/strategic-map/components/StrategicTable.jsx

import React from 'react';
import { useOrganization } from '../../../contexts/OrganizationContext';
import { Card } from '../../../components/ui/card';
import { Button } from '../../../components/ui/button';

/**
 * StrategicTable Component
 *
 * Displays strategic planning grid with yearly/monthly/weekly/daily views
 *
 * @param {Object} props
 * @param {Array} props.categories - Row categories (6 strategic dimensions)
 * @param {Array} props.columns - Column headers (years/months/weeks/days)
 * @param {string} props.storageKey - LocalStorage key for persistence
 * @param {Function} props.onAddColumn - Callback to add new column
 */
const StrategicTable = ({ categories, columns, storageKey, onAddColumn }) => {
  const { organizationSlug } = useOrganization();

  // Component implementation

  return (
    <Card className="mb-6">
      {/* Table content */}
    </Card>
  );
};

export default StrategicTable;
```

### Naming Conventions

- **Components**: PascalCase (e.g., `StrategicTable.jsx`)
- **Utilities**: camelCase (e.g., `dateCalculations.js`)
- **Hooks**: `use` prefix (e.g., `useStrategicData.js`)
- **Constants**: UPPER_SNAKE_CASE (e.g., `CATEGORIES`, `API_ENDPOINTS`)
- **Files**: Match component name (e.g., `Button.jsx` contains `Button` component)

### Component Documentation

All components should include:
1. **JSDoc comment** with description
2. **PropTypes** or TypeScript types
3. **Usage example** in comment or separate README
4. **Accessibility notes** if relevant

---

## 4. UI/UX Guidelines

### Design System

**Color Palette**:
```javascript
// tailwind.config.js
colors: {
  primary: {
    50: '#e3f2fd',
    100: '#bbdefb',
    500: '#0C6DCD',  // Lark brand blue
    700: '#084891',
    900: '#05325e',
  },
  secondary: {
    500: '#a855f7',  // Purple accent
    600: '#9333ea',
  },
  success: {
    DEFAULT: '#22c55e',
    light: '#86efac',
    dark: '#16a34a',
  },
  error: {
    DEFAULT: '#ef4444',
    light: '#fca5a5',
    dark: '#dc2626',
  },
  neutral: {
    50: '#f9fafb',
    100: '#f3f4f6',
    200: '#e5e7eb',
    500: '#6b7280',
    700: '#374151',
    900: '#111827',
  }
}
```

**Typography**:
```css
/* Headings */
.heading-xl { @apply font-inter font-bold text-3xl; }
.heading-lg { @apply font-inter font-bold text-2xl; }
.heading-md { @apply font-inter font-semibold text-xl; }
.heading-sm { @apply font-inter font-semibold text-lg; }

/* Body */
.body-lg { @apply font-inter text-base; }
.body-md { @apply font-inter text-sm; }
.body-sm { @apply font-inter text-xs; }

/* Code */
.code { @apply font-mono text-sm; }
```

**Spacing Scale**: Use Tailwind's default (4px base unit)
- `p-1` = 4px
- `p-2` = 8px
- `p-4` = 16px
- `p-6` = 24px
- `p-8` = 32px

**Border Radius**:
- Small: `rounded-md` (6px)
- Medium: `rounded-lg` (8px)
- Large: `rounded-xl` (12px)
- XLarge: `rounded-2xl` (16px)
- Cards: `rounded-3xl` (24px for feature cards)

**Shadow Scale**:
- Subtle: `shadow-sm` (0 1px 2px)
- Default: `shadow` (0 1px 3px)
- Medium: `shadow-md` (0 4px 6px)
- Large: `shadow-lg` (0 10px 15px)

### Component Styling Patterns

**Button Variants**:
```jsx
// Primary action
<Button className="bg-primary-500 text-white hover:bg-primary-700 transition-colors">
  Save Changes
</Button>

// Secondary action
<Button className="bg-neutral-100 text-neutral-900 hover:bg-neutral-200 border border-neutral-300">
  Cancel
</Button>

// Destructive action
<Button className="bg-error text-white hover:bg-red-600">
  Delete Item
</Button>

// Ghost/subtle action
<Button className="text-primary-500 hover:bg-primary-50">
  Learn More
</Button>
```

**Card Styles**:
```jsx
// Standard card
<Card className="rounded-xl shadow-sm hover:shadow-md transition-shadow duration-300">
  <CardContent className="p-6">
    {/* Content */}
  </CardContent>
</Card>

// Interactive card (clickable)
<Card className="rounded-xl shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 cursor-pointer">
  <CardContent className="p-6">
    {/* Content */}
  </CardContent>
</Card>

// Highlighted card
<Card className="rounded-xl border-2 border-primary-500 bg-primary-50">
  <CardContent className="p-6">
    {/* Content */}
  </CardContent>
</Card>
```

**Table Styles**:
```jsx
<table className="w-full border-collapse bg-white rounded-xl overflow-hidden">
  <thead>
    <tr className="bg-primary-500 text-white">
      <th className="px-4 py-3 text-left font-semibold">Column</th>
    </tr>
  </thead>
  <tbody>
    <tr className="border-b border-neutral-200 hover:bg-neutral-50">
      <td className="px-4 py-3">Data</td>
    </tr>
  </tbody>
</table>
```

**Responsive Patterns**:
```jsx
// Responsive grid
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
  {/* Items */}
</div>

// Responsive padding
<div className="px-4 md:px-6 lg:px-8">
  {/* Content */}
</div>

// Responsive text
<h1 className="text-2xl md:text-3xl lg:text-4xl font-bold">
  Heading
</h1>
```

### Accessibility Standards

**Required Practices**:
- All interactive elements must have `aria-label` or visible text
- Color contrast ratio: minimum 4.5:1 for normal text, 3:1 for large text
- Keyboard navigation: all actions accessible via Tab/Enter/Space
- Focus indicators: visible outline on focused elements (`focus:ring-2 focus:ring-primary-500`)
- Alt text for all images
- Semantic HTML (use `<button>`, `<nav>`, `<main>`, etc.)

**Example**:
```jsx
<button
  aria-label="Close dialog"
  className="focus:ring-2 focus:ring-primary-500 focus:outline-none"
  onClick={handleClose}
>
  <X size={20} />
</button>
```

---

## 5. Multi-Tenant Implementation

### Organization Context Flow

```
1. User opens app
   â†“
2. OrganizationSelector loads available organizations from Supabase
   â†“
3. User selects organization
   â†“
4. organizationSlug stored in localStorage
   â†“
5. OrganizationProvider propagates context to all components
   â†“
6. All API calls include ?organization_slug=X parameter
   â†“
7. Backend validates organization exists & fetches Lark credentials
   â†“
8. Session stores organization_id for subsequent requests
```

### Organization-Specific Features

**Lark Credentials Storage**:
```sql
-- organizations table
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  lark_credentials JSONB NOT NULL,  -- { app_id, app_secret, ... }
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Example lark_credentials JSONB:
{
  "app_id": "cli_a5...",
  "app_secret": "xxx...",
  "encrypt_key": "...",
  "verification_token": "..."
}
```

**API Request Pattern**:
```javascript
// Frontend
import { useOrganization } from '../contexts/OrganizationContext';

const MyComponent = () => {
  const { organizationSlug } = useOrganization();

  const fetchData = async () => {
    const response = await axios.get(
      `/api/strategic_map?organization_slug=${organizationSlug}`
    );
    return response.data;
  };
};

// Backend (server/server.js or api/*.js)
const { getOrganizationBySlug } = require('../server/organization_helper');

router.get('/api/strategic_map', async (ctx) => {
  const organizationSlug = ctx.query.organization_slug;

  // 1. Validate organization exists
  const org = await getOrganizationBySlug(organizationSlug);
  if (!org) {
    ctx.status = 404;
    ctx.body = { error: 'Organization not found' };
    return;
  }

  // 2. Extract org-specific Lark credentials
  const { app_id, app_secret } = org.lark_credentials;

  // 3. Process request with org context
  const data = await fetchStrategicMapItems(org.id);
  ctx.body = { success: true, data };
});
```

### Role-Based Access Control

**Flow**:
```
1. User authenticates with Lark
   â†“
2. Backend queries: get_auth_user_by_lark(lark_user_id, email)
   â†“
3. Get individuals.id by user_id
   â†“
4. Get organization_members.role_code by individual_id + organization_id
   â†“
5. Set session.is_admin = (role_code === 'admin' || role_code === 'owner')
   â†“
6. Frontend checks isAdmin to show/hide features
```

**Implementation**:
```javascript
// Backend session setup
session.is_admin = (role_code === 'admin' || role_code === 'owner');
session.role_code = role_code;
session.organization_id = organization.id;

// Frontend role check
import { useAuth } from '../contexts/AuthContext';

const AdminOnlyFeature = () => {
  const { isAdmin } = useAuth();

  if (!isAdmin) return null;

  return (
    <Button onClick={handleAdminAction}>
      Admin-Only Action
    </Button>
  );
};
```

**Roles**:
- `owner`: Full permissions, can delete organization
- `admin`: Manage members, settings, all tools
- `member`: Use tools, view data (limited write access)

---

## 6. Lark Integration Patterns

### Authentication Flow

**JSAPI Authentication (Production - Inside Lark App)**:
```javascript
import { handleJSAPIAccess } from '../utils/auth_access_util';

// 1. Get JSAPI signature from backend
const signParams = await axios.get(
  `/api/get_sign_parameters?organization_slug=${organizationSlug}`
);

// 2. Initialize Lark JSAPI
window.h5sdk.config({
  appId: orgSpecificAppId,  // From localStorage (org-specific)
  timestamp: signParams.timestamp,
  nonceStr: signParams.nonceStr,
  signature: signParams.signature,
  jsApiList: [],
  onSuccess: () => {
    // 3. Request authorization code
    window.tt.requestAuthCode({
      appId: orgSpecificAppId,
      success: async (res) => {
        // 4. Exchange code for user_access_token
        const userInfo = await axios.post(
          `/api/get_user_access_token`,
          {
            code: res.code,
            organization_slug: organizationSlug
          }
        );
        setUserInfo(userInfo.data);
      },
      fail: (err) => {
        console.error('Auth code failed:', err);
      }
    });
  },
  onFail: (err) => {
    console.error('JSAPI config failed:', err);
  }
});
```

**OAuth 2.0 Flow (Development - External Browser)**:

Enabled when `REACT_APP_ALLOW_EXTERNAL_BROWSER=true`:

```javascript
import { handleUserAuth } from '../utils/auth_access_util';

// 1. Detect JSAPI unavailable â†’ Redirect to Lark OAuth
const oauthUrl = `https://open.feishu.cn/open-apis/authen/v1/authorize?
  app_id=${appId}&
  redirect_uri=${encodeURIComponent(callbackUrl)}&
  state=${organizationSlug}`;  // Pass org context via state

window.location.href = oauthUrl;

// 2. Handle OAuth callback (after user authorizes)
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');
const organizationSlug = urlParams.get('state');

// 3. Exchange code for user_access_token (same endpoint as JSAPI)
const userInfo = await axios.post(`/api/get_user_access_token`, {
  code,
  organization_slug: organizationSlug
});

// 4. Store token and sync user to Supabase
Cookies.set('lk_token', userInfo.access_token);
```

**Token Revalidation Strategy**:
```javascript
// When Lark API returns token expiration error
if (response.code === -2 || response.code === 99991663) {
  // 1. Clear invalid token
  Cookies.remove('lk_token');
  localStorage.removeItem('lk_token');

  // 2. Restart authentication (prevents redirect loops)
  await handleUserAuth();
}
```

### Lark API Call Pattern

**Backend Helper**:
```javascript
// server/server_util.js or lib/larkAPI.js
const axios = require('axios');

/**
 * Generic Lark API caller
 * @param {string} endpoint - API endpoint (e.g., '/authen/v1/user_info')
 * @param {object} data - Request body
 * @param {string} accessToken - user_access_token or tenant_access_token
 * @param {string} method - HTTP method (default: POST)
 */
const callLarkAPI = async (endpoint, data = {}, accessToken, method = 'POST') => {
  try {
    const response = await axios({
      method,
      url: `https://open.feishu.cn/open-apis${endpoint}`,
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      data: method === 'GET' ? undefined : data,
      params: method === 'GET' ? data : undefined
    });

    if (response.data.code !== 0) {
      throw new Error(`Lark API Error: ${response.data.msg}`);
    }

    return response.data;
  } catch (error) {
    console.error('Lark API call failed:', error);
    throw error;
  }
};

module.exports = { callLarkAPI };
```

**Example: Get User Info**:
```javascript
const { callLarkAPI } = require('./larkAPI');

const getUserInfo = async (userAccessToken) => {
  return callLarkAPI('/authen/v1/user_info', {}, userAccessToken, 'GET');
};

// Usage
const userInfo = await getUserInfo(session.lk_token);
console.log(userInfo.data.name, userInfo.data.email);
```

**Example: Get Tenant Access Token**:
```javascript
const getTenantAccessToken = async (appId, appSecret) => {
  const response = await callLarkAPI(
    '/auth/v3/tenant_access_token/internal',
    { app_id: appId, app_secret: appSecret },
    null,  // No auth token needed for this endpoint
    'POST'
  );
  return response.tenant_access_token;
};
```

### Common Lark API Endpoints

| Purpose | Endpoint | Token Type | Method |
|---------|----------|------------|--------|
| Get user info | `/authen/v1/user_info` | user_access_token | GET |
| Get tenant token | `/auth/v3/tenant_access_token/internal` | None (uses app credentials) | POST |
| Get JSAPI ticket | `/jssdk/ticket/get` | tenant_access_token | POST |
| Get user by ID | `/contact/v3/users/:user_id` | tenant_access_token | GET |
| List departments | `/contact/v3/departments` | tenant_access_token | GET |
| Send message | `/im/v1/messages` | tenant_access_token | POST |

**Documentation**: See [docs/lark/lark-api-overview.md](docs/lark/lark-api-overview.md)

---

## 7. Development Workflow

### Adding a New Tool

**Step 1: Create Tool Folder**
```bash
mkdir -p src/tools/my-new-tool/{components,hooks,utils}
touch src/tools/my-new-tool/index.jsx
touch src/tools/my-new-tool/README.md
```

**Step 2: Copy Template** (once template exists)
```bash
cp -r src/tools/_template/* src/tools/my-new-tool/
```

**Step 3: Implement Tool**
```javascript
// src/tools/my-new-tool/index.jsx
import React, { useState, useEffect } from 'react';
import { useOrganization } from '../../contexts/OrganizationContext';
import { Card } from '../../components/ui/card';
import { Button } from '../../components/ui/button';
import axios from 'axios';

const MyNewTool = () => {
  const { organizationSlug } = useOrganization();
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchData();
  }, [organizationSlug]);

  const fetchData = async () => {
    try {
      const response = await axios.get(
        `/api/my_new_tool?organization_slug=${organizationSlug}`
      );
      setData(response.data.data);
    } catch (error) {
      console.error('Failed to fetch data:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <h1 className="text-3xl font-bold mb-6">My New Tool</h1>

      {loading ? (
        <div>Loading...</div>
      ) : (
        <Card className="p-6">
          {/* Tool content */}
        </Card>
      )}
    </div>
  );
};

export default MyNewTool;
```

**Step 4: Add Route to Home Dashboard**
```javascript
// src/pages/home/index.js
import MyNewTool from '../../tools/my-new-tool';

// In HomePage component
const [view, setView] = useState('dashboard');

const renderView = () => {
  switch (view) {
    case 'dashboard':
      return <DashboardContent onNavigate={setView} />;
    case 'my_new_tool':
      return <MyNewTool />;
    // ... other cases
  }
};

// In DashboardContent
<Grid item xs={12} sm={6} md={4}>
  <Card
    className="cursor-pointer hover:shadow-lg transition-shadow"
    onClick={() => onNavigate('my_new_tool')}
  >
    <CardContent className="p-6 text-center">
      <div className="text-4xl mb-4">ðŸ”§</div>
      <h3 className="text-xl font-bold">My New Tool</h3>
      <p className="text-gray-600 mt-2">Tool description</p>
    </CardContent>
  </Card>
</Grid>
```

**Step 5: Create Backend API**
```javascript
// api/my_new_tool.js (Vercel serverless function)
const { getOrganizationBySlug } = require('../server/organization_helper');
const { createClient } = require('@supabase/supabase-js');

module.exports = async (req, res) => {
  const organizationSlug = req.query.organization_slug;

  // Validate organization
  const org = await getOrganizationBySlug(organizationSlug);
  if (!org) {
    return res.status(404).json({ error: 'Organization not found' });
  }

  // Implement tool API logic
  const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
  const { data, error } = await supabase
    .from('my_tool_data')
    .select('*')
    .eq('organization_id', org.id);

  if (error) {
    return res.status(500).json({ error: error.message });
  }

  res.json({ success: true, data });
};
```

```javascript
// server/server.js (Koa route for development)
router.get('/api/my_new_tool', async (ctx) => {
  const organizationSlug = ctx.query.organization_slug;

  // Same logic as Vercel function
  const org = await getOrganizationBySlug(organizationSlug);
  if (!org) {
    ctx.status = 404;
    ctx.body = { error: 'Organization not found' };
    return;
  }

  // ... rest of implementation
});
```

**Step 6: Document**
```bash
mkdir -p docs/tools/my-new-tool
cat > docs/tools/my-new-tool/README.md << 'EOF'
# My New Tool

## Purpose
Brief description of what this tool does.

## Features
- Feature 1
- Feature 2

## Technical Details
- Database tables used
- Lark API endpoints called
- Key algorithms/logic

## Usage
How to use this tool from user perspective.
EOF
```

### Git Workflow

```bash
# 1. Create feature branch
git checkout -b feature/my-new-tool

# 2. Make changes, commit frequently
git add .
git commit -m "feat: add My New Tool UI skeleton"

git add .
git commit -m "feat: implement My New Tool backend API"

git add .
git commit -m "docs: add My New Tool documentation"

# 3. Final commit with Claude Code signature
git commit -m "feat: add My New Tool

- Implement tool UI with Tailwind CSS
- Add backend API for data fetching
- Add documentation
- Add to home dashboard

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# 4. Push and create PR
git push origin feature/my-new-tool

# 5. Create pull request using gh CLI
gh pr create --title "Add My New Tool" --body "$(cat <<'EOF'
## Summary
- New Lark integration tool for [purpose]

## Changes
- Created `/src/tools/my-new-tool/` with full implementation
- Added `/api/my_new_tool.js` serverless function
- Added Koa route in `server/server.js`
- Added documentation in `docs/tools/my-new-tool/`
- Updated home dashboard with tool card

## Test Plan
- [x] Tool loads correctly
- [x] API calls work with organization context
- [x] Multi-tenant isolation verified
- [x] Error handling tested
- [x] Responsive design tested

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

### Code Review Checklist

Before submitting PR, verify:

- [ ] Follows tool-based folder structure (`src/tools/...`)
- [ ] Uses Tailwind CSS (no Material-UI)
- [ ] Includes organization context validation
- [ ] Has proper error handling (try/catch, user-friendly messages)
- [ ] Includes JSDoc comments for functions/components
- [ ] No hardcoded credentials (uses env vars or Supabase)
- [ ] Responsive design tested (mobile, tablet, desktop)
- [ ] Accessibility standards met (keyboard nav, aria-labels, color contrast)
- [ ] Both Koa and Vercel APIs updated (if backend changes)
- [ ] Documentation added (`docs/tools/{tool-name}/README.md`)

---

## 8. Change Log

### Template for Updates

```markdown
## [Version] - YYYY-MM-DD

### Added
- New feature, tool, or component

### Changed
- Modified behavior, structure, or API

### Deprecated
- Features scheduled for removal (include timeline)

### Removed
- Deleted features, files, or dependencies

### Fixed
- Bug fixes and issue resolutions

### Security
- Security improvements or vulnerability fixes
```

---

### Version History

## [2.0.0] - 2025-11-14

### Added
- Tool-based folder structure (`/src/tools/`)
- ARCHITECTURE.md master document (this file)
- Architecture Decision Records (ADR-001 through ADR-005)
- shadcn/ui component library (planned)
- OrganizationContext provider (planned)
- Design system guidelines (color palette, typography, spacing)

### Changed
- Migrated from Material-UI to Tailwind CSS (in progress)
- Standardized on strategic-map-v2 pattern
- Consolidated component organization strategy
- Improved documentation structure

### Deprecated
- Material-UI components (will be removed in v3.0)
- Old StrategicMap component (`src/components/StrategicMap/`) - archived
- Individual component CSS files (migrating to Tailwind utilities)

### Removed
- None (archived old components for reference)

---

## [1.0.0] - 2024-12-20

### Added
- Strategic Map tool with database cascading
- Multi-tenant architecture with organization context
- Dual authentication (JSAPI + OAuth)
- Supabase integration
- PostgreSQL triggers for strategic map cascading
- Session-based authentication with token revalidation
- Role-based access control (owner, admin, member)
- Hybrid deployment (Koa dev + Vercel production)

### Database
- `organizations` table with `lark_credentials` JSONB
- `strategic_map_items` table with cascade triggers
- `organization_members` table with role-based access
- `get_auth_user_by_lark()` RPC function

### Documentation
- Initial CLAUDE.md for AI agents
- Strategic Map documentation suite
- Lark API integration guides
- OAuth local development guide

---

## 9. Onboarding Guide

### For New Developers

**Day 1: Setup & Environment**

1. **Clone repository**:
   ```bash
   git clone <repo-url>
   cd InsideCloud
   ```

2. **Install dependencies**:
   ```bash
   npm install
   ```

3. **Configure environment**:
   ```bash
   cp .env.example .env
   # Edit .env with your Supabase credentials
   ```

4. **Setup Lark app credentials**:
   ```bash
   npm run config
   # Follow interactive prompts to enter App ID and App Secret
   ```

5. **Start development**:
   ```bash
   npm run start
   # Opens http://localhost:3000
   ```

---

**Day 2: Architecture Study**

1. **Read core documentation**:
   - This document (ARCHITECTURE.md) - architecture decisions
   - [CLAUDE.md](CLAUDE.md) - operational commands
   - [docs/project/project-understanding.md](docs/project/project-understanding.md) - getting started

2. **Explore codebase**:
   - `/src/tools/strategic-map/` - Main tool implementation
   - `/server/server.js` - Koa backend APIs
   - `/api/strategic_map.js` - Vercel serverless function
   - `/src/components/organizationSelector/` - Multi-tenant selector

3. **Understand key concepts**:
   - Multi-tenant architecture (organization_slug pattern)
   - Dual authentication (JSAPI vs OAuth)
   - Database-driven cascading (PostgreSQL triggers)
   - Hybrid deployment (Koa + Vercel)

---

**Day 3: First Contribution**

1. **Pick a small issue**:
   - Check GitHub Issues for "good first issue" label
   - Or fix a typo in documentation

2. **Create feature branch**:
   ```bash
   git checkout -b fix/my-first-fix
   ```

3. **Make changes**:
   - Follow component standards (Section 3)
   - Use Tailwind CSS (Section 4)
   - Test locally (`npm run start`)

4. **Submit pull request**:
   ```bash
   git add .
   git commit -m "fix: your fix description"
   git push origin fix/my-first-fix
   gh pr create
   ```

5. **Respond to code review**:
   - Address feedback promptly
   - Ask questions if unclear
   - Update based on review comments

---

### For AI Agents (Claude Code)

**Initialization Checklist**:

When starting work in this repository, follow this sequence:

1. âœ… **Read ARCHITECTURE.md** (this file) - understand architecture decisions
2. âœ… **Read CLAUDE.md** - understand operational commands and development workflow
3. âœ… **Check recent commits** - understand current work context
   ```bash
   git log --oneline -10
   ```
4. âœ… **Review current issues/PRs** - understand active tasks
   ```bash
   gh issue list
   gh pr list
   ```
5. âœ… **Identify tool you'll be working on** - locate in `/src/tools/`
6. âœ… **Review tool-specific documentation** - `/docs/tools/{tool-name}/`

---

**Decision Framework**:

When making architectural decisions:

1. **Check if ADR exists** for this pattern:
   - Search ARCHITECTURE.md Section 2
   - Example: "Should I use Material-UI or Tailwind?" â†’ ADR-002

2. **If ADR exists**: Follow established pattern
   - Example: Use Tailwind CSS for new components

3. **If no ADR exists**: Propose new decision
   - Document rationale
   - Explain alternatives considered
   - List consequences (pros/cons)
   - Add to Section 2 with new ADR number

4. **Prioritize**: Maintainability > Cleverness
   - Clear, simple code is better than complex optimizations
   - Future developers (AI or human) should easily understand

5. **Update documentation**: Always update relevant docs when making changes
   - Update ARCHITECTURE.md if architecture changes
   - Update tool-specific README if tool behavior changes
   - Update CLAUDE.md if development workflow changes

---

**Common Tasks Quick Reference**:

| Task | Documentation | Command/Path |
|------|---------------|--------------|
| Add new tool | Section 7 "Adding a New Tool" | `mkdir src/tools/new-tool` |
| Fix bug | `/docs/tools/{tool}/` | Check tool-specific docs |
| Update UI | Section 4 "UI/UX Guidelines" | Use Tailwind CSS + shadcn/ui |
| API changes | Section 6 "Lark Integration" | Update both `server/` and `api/` |
| Database changes | ADR-003, cascade docs | Use Supabase migrations |
| Authentication | Section 6 "Authentication Flow" | Check auth_access_util.js |

---

**Communication Patterns**:

When working with users:

1. **Ask clarifying questions** before implementation:
   - "Should this tool be accessible to all roles or admin-only?"
   - "Which Lark API endpoint should I use for this feature?"

2. **Explain architectural decisions**:
   - "I'm using Tailwind CSS per ADR-002"
   - "This will require both Koa and Vercel updates per ADR-004"

3. **Propose alternatives** when multiple approaches exist:
   - "We can implement this with frontend logic or database trigger. Database trigger (ADR-003) is more reliable but harder to debug."

4. **Update documentation** proactively:
   - "I've added this new tool to the documentation in `/docs/tools/`"
   - "I've updated ARCHITECTURE.md with the new pattern"

---

## Quick Reference

### Key Files

| File | Purpose |
|------|---------|
| **ARCHITECTURE.md** (this file) | Architecture decisions, component standards, design system |
| **CLAUDE.md** | Operational guide for AI agents, development commands |
| **package.json** | Dependencies, scripts, project metadata |
| **tailwind.config.js** | Design system configuration (colors, fonts, animations) |
| **vercel.json** | Deployment configuration for Vercel |
| **.env** | Environment variables (Supabase, Lark credentials) |

### Key Directories

| Directory | Purpose |
|-----------|---------|
| **src/tools/** | All Lark integration tools (strategic-map, future tools) |
| **src/components/ui/** | shadcn/ui component library (Button, Card, Table, etc.) |
| **src/components/layout/** | Shared layout components (Topbar, ProtectedLayout) |
| **src/components/organization/** | Organization-related components (OrganizationSelector) |
| **api/** | Vercel serverless functions (production) |
| **server/** | Koa development server (local) |
| **lib/** | Shared utilities (larkUserSync, etc.) |
| **docs/** | All documentation (architecture, tools, guides, Lark APIs) |
| **archived/** | Deprecated code (old StrategicMap, etc.) |

### Key Commands

```bash
# Development
npm run config              # Configure Lark app credentials (interactive)
npm run start               # Start dev server (Koa + React)
npm run start:web           # React dev server only (port 3000)
npm run start:server        # Koa backend server only (port 8989)
npm run start:with-ngrok    # Start with ngrok tunnel for Lark testing

# Build & Deploy
npm run build               # Production build (creates /build)
npm run deploy              # Deploy to Vercel production
npm run deploy:preview      # Deploy to Vercel preview environment

# Testing
# No test suite currently configured
```

### Key Concepts

| Concept | Description | Reference |
|---------|-------------|-----------|
| **Multi-Tenant** | Each organization has isolated data and Lark credentials | Section 5, ADR-001 |
| **Dual Auth** | JSAPI (production) + OAuth (development) | Section 6 |
| **Database Cascading** | PostgreSQL triggers handle strategic map cascading | ADR-003 |
| **Hybrid Deployment** | Koa (dev) + Vercel serverless (prod) | ADR-004 |
| **Tool-Based Structure** | Tools in `/src/tools/`, shared components in `/src/components/` | ADR-001 |
| **Tailwind CSS** | Primary styling framework (replacing Material-UI) | ADR-002 |

### Key Contacts

- **Project Lead**: [Name/Email]
- **Backend Lead**: [Name/Email]
- **Frontend Lead**: [Name/Email]
- **Documentation**: `/docs/README.md`
- **Support**: GitHub Issues

---

## Appendix

### Related Documentation

- **Project Understanding**: [docs/project/project-understanding.md](docs/project/project-understanding.md)
- **Strategic Map Solution**: [docs/strategic-map/strategic-map-solution-summary.md](docs/strategic-map/strategic-map-solution-summary.md)
- **Strategic Map CRUD Guide**: [docs/strategic-map/strategic-map-crud-guide.md](docs/strategic-map/strategic-map-crud-guide.md)
- **Strategic Map Cascade Flow**: [docs/strategic-map/strategic-map-cascade-flow.md](docs/strategic-map/strategic-map-cascade-flow.md)
- **Lark API Overview**: [docs/lark/lark-api-overview.md](docs/lark/lark-api-overview.md)
- **OAuth Local Development**: [docs/guides/oauth-local-development.md](docs/guides/oauth-local-development.md)

### External Resources

- **Lark Open Platform**: https://open.feishu.cn/document/home
- **Tailwind CSS**: https://tailwindcss.com/docs
- **shadcn/ui**: https://ui.shadcn.com
- **Radix UI**: https://www.radix-ui.com
- **Supabase**: https://supabase.com/docs
- **Vercel**: https://vercel.com/docs

---

**Document Status**: Living Document
**Review Frequency**: Monthly or after major changes
**Next Review**: 2025-12-14
**Last Reviewed By**: AI Agent (Claude Code)
